# Sugar (数格) 项目现状总结

## 1. 项目概述

Sugar 是一个基于成熟的 Gin-Vue-Admin 框架深度定制开发的智能化在线数据分析与协作平台。前端核心交互界面采用了高性能的开源表格引擎 Univer。该平台旨在打造一个集数据连接、语义建模、智能分析与团队协作为一体的在线 SaaS 应用，让业务用户能像使用电子表格一样方便地进行复杂的数据查询和分析。

项目采用开源协议，代码结构清晰，可以直接部署运行。

## 2. 技术栈

### 2.1. 后端技术栈
- **框架**: Gin (v1.10.0) - 高性能 Go Web 框架
- **语言**: Go (v1.23)
- **数据库**: MySQL 8+ (主要)，支持 PostgreSQL、SQL Server、SQLite
- **ORM**: GORM (v1.25.12)
- **权限控制**: Casbin (v2.103.0)
- **缓存**: Go-Redis (v9.7.0)
- **配置管理**: Viper (v1.19.0)
- **日志**: Zap (v1.27.0)

### 2.2. 前端技术栈
- **框架**: Vue.js (v3.5.7)
- **构建工具**: Vite (v6.2.3)
- **UI 库**: Element Plus (v2.10.2)
- **核心表格引擎**: Univer (v0.10.1)
- **状态管理**: Pinia (v2.2.2)
- **路由**: Vue Router (v4.4.3)
- **HTTP 客户端**: Axios (v1.8.2)

## 3. 核心功能模块

### 3.1. 表格管理与协作
- **文件树管理**: 支持层级化文件和文件夹结构
- **在线表格编辑**: 基于 Univer 的增删改查和保存功能
- **团队协作**: 以团队为核心的多租户协作模式
- **权限控制**: 精细化的 RBAC 权限系统，权限绑定在团队上

### 3.2. 自定义公式系统
项目实现了扩展 Univer 公式系统的能力，支持两种类型的自定义公式：

**AI 相关公式**:
- `AI.FETCH`: 通过自然语言查询调用数据库数据进行分析
- `AI.EXPLAINRange`: 对表格中指定范围的数据进行 AI 分析解释

**数据查询公式**:
- `SUGAR.CALC`: 基于语义模型进行数据计算
- `SUGAR.GET`: 基于语义模型进行数据获取

### 3.3. 语义层 (Semantic Layer)
作为项目的核心创新，语义层允许管理员将物理数据表封装成面向业务的语义模型：
- **数据连接器**: 配置并安全存储外部数据库连接信息
- **语义模型**: 定义可查询的维度、可计算的指标和参数化筛选条件
- **模型共享**: 支持语义模型在团队间的共享

### 3.4. AI Agent 集成
- **Agent 定义**: 通过 `sugar_agents` 表定义可被公式调用的 AI Agent
- **Agent 共享**: 支持 AI Agent 在团队间的共享
- **调用集成**: 公式系统可通过 `CALL_AGENT` 语法调用外部 AI 服务

### 3.5. 精细化权限控制
- **工作区权限**: 通过 `sugar_workspace_permissions` 实现文件/文件夹的显式授权
- **行级安全**: 通过 `sugar_city_permissions` 和 `permission_key_column` 实现数据行级访问控制
- **权限豁免**: 支持管理员等特殊用户的权限豁免机制

### 3.6. 审计与日志
- **执行日志**: `sugar_execution_logs` 表记录所有高成本的后台任务
- **日志类型**: 支持数据库查询和 AI Agent 调用的日志记录
- **详细记录**: 包含输入输出、执行时间、状态等完整信息

## 4. 数据表结构

项目采用 MySQL 数据库，核心数据表结构如下：

### 4.1. 团队与权限管理
- `sugar_teams`: 统一管理团队和个人空间
- `sugar_team_members`: 用户与团队的多对多关系
- `sugar_workspace_permissions`: 精细化控制文件/文件夹权限
- `sugar_share_links`: 支持通过链接分享文件

### 4.2. 资源管理
- `sugar_workspaces`: 统一存储文件和文件夹，归属逻辑简化为关联 team_id
- `sugar_file_versions`: 存储文件的历史版本，支持版本回溯

### 4.3. 语义层配置
- `sugar_db_connections`: 存储外部及内部数据库连接信息
- `sugar_db_connection_shares`: 记录数据库连接的共享关系
- `sugar_semantic_models`: 核心语义层，将物理表封装为业务对象
- `sugar_semantic_model_shares`: 记录语义模型的共享关系

### 4.4. AI 集成
- `sugar_agents`: 定义可被公式调用的 AI Agent
- `sugar_agent_shares`: 记录 AI Agent 的共享关系

### 4.5. 行级权限控制
- `sugar_city_permissions`: 存储用户有权访问的城市数据
- `sugar_row_level_overrides`: 配置可忽略行级权限的用户

### 4.6. 审计日志
- `sugar_execution_logs`: 记录所有高成本的后台任务执行

## 5. 前端架构

### 5.1. 整体架构设计
前端采用先进的"组合式函数驱动"插件化架构：
- **组合式函数**: 将复杂逻辑下沉到独立的 Vue Composition API 函数中
- **插件化设计**: 支持动态加载功能面板和自定义公式
- **响应式状态管理**: 统一使用 Pinia 进行状态管理
- **事件总线**: 实现模块间的解耦通信

### 5.2. 核心组件结构
```
web/src/
├── composables/          # 组合式函数
│   ├── useApp.ts        # 应用协调器，管理启动/关闭流程
│   ├── usePluginManager.ts  # 插件管理器
│   └── useWorkbookManager.ts # 工作簿管理器
├── core/                 # 核心逻辑
│   ├── plugin/           # 插件系统
│   ├── events/           # 事件总线
│   └── store/            # Pinia 状态管理
├── plugins/              # 功能插件
│   ├── univer-core/      # Univer 核心封装
│   └── custom-formulas/  # 自定义公式
└── view/sugar/index.vue  # 主页面（瘦组件）
```

### 5.3. UI 界面现状
- **左侧文件树**: 基于工作空间侧边栏，支持多工作空间切换、搜索、收藏等功能
- **中部表格区域**: 核心 Univer 表格编辑区域，支持在线编辑和保存
- **右侧 AI 和数据透视面板**: 功能暂未实现，预留用于交互界面

### 5.4. 工作空间侧边栏功能
新增的工作空间侧边栏提供完整的文件管理体验：
- **多工作空间支持**: 在多个团队工作空间间切换
- **文件树形结构**: 层级化显示，支持展开/折叠
- **搜索功能**: 实时搜索文件和文件夹
- **三个视图模式**: 文件树视图、最近访问、收藏
- **文件操作**: 新建、重命名、删除、收藏等
- **响应式设计**: 适配不同屏幕尺寸

## 6. 数据匿名化服务

项目实现了完整的数据隐私保护方案，专为贡献度分析优化的轻量级方案：
- **统一匿名标准**: 无需复杂配置
- **专注贡献度**: 仅返回贡献度百分比，不返回原始数值
- **语义映射**: 保留维度间的业务关系
- **轻微噪声**: 可配置的轻微数值扰动

匿名化服务在数据查询后对结果进行处理，确保 AI 分析时使用脱敏数据，最终返回给前端时进行解密还原。

## 7. 部署与运行

项目基于 Gin-Vue-Admin 框架，可以直接部署运行：
- **后端**: Go 应用，支持标准 Web 服务器部署
- **前端**: Vue.js 单页应用，可部署到 Nginx 或 CDN
- **数据库**: MySQL 8+，支持自动初始化表结构
- **依赖**: 所有依赖通过 go.mod 和 package.json 管理

## 8. 开发状态与规划

### 当前完成度
- ✅ 核心表格编辑功能
- ✅ 自定义公式系统
- ✅ 语义层数据查询
- ✅ AI Agent 集成
- ✅ 团队协作与权限控制
- ✅ 数据匿名化服务
- ✅ 工作空间侧边栏
- ✅ 前端插件化架构重构

### 待实现功能
- 🔄 前端 AI 聊天面板
- 🔄 数据透视表插件
- 🔄 文件版本历史
- 🔄 更丰富的权限控制选项

该项目已具备完整的数据分析与协作能力，为业务用户提供了强大的在线表格工具，同时通过 AI 集成和隐私保护确保了数据的安全和智能分析。


本地开发命令：
```
启动后端
cd server
go run main.go

启动前端
cd web
npm run serve

```